<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metric-Affine Elastic (EMA) - Theory - AGISystem2</title>
  <link rel="stylesheet" href="../../reference/style.css">
  <style>
    .diagram-container { margin: 20px 0; }
    .concept-box {
      background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
      border-left: 4px solid #00897b;
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
    }
    .concept-box h4 { margin-top: 0; color: #00695c; }
    .math-block {
      background: #263238;
      color: #b2dfdb;
      padding: 20px;
      border-radius: 8px;
      font-family: monospace;
      overflow-x: auto;
      margin: 15px 0;
    }
    .definition {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .definition strong { color: #1565c0; }
    .warning-box {
      background: #fff8e1;
      border: 1px solid #ffc107;
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .intuition {
      background: #f1f8e9;
      border-left: 4px solid #7cb342;
      padding: 15px 20px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .intuition em { color: #558b2f; font-style: normal; font-weight: bold; }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    .comparison-table th {
      background: #00897b;
      color: white;
    }
    .comparison-table tr:nth-child(even) {
      background: #e0f2f1;
    }
    .legend-chip {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-right: 6px;
      background: #e0f2f1;
      color: #00695c;
    }
  </style>
</head>
<body>
  <div class="page">
  <div class="nav-header">
    <h1>Metric-Affine Elastic (EMA)</h1>
    <small>
      <a href="../../index.html">Home</a> &middot;
      <a href="../index.html">Theory</a> &middot;
      <a href="dense-binary.html">Dense-Binary</a> &middot;
      <a href="sparse-polynomial.html">SPHDC</a> &middot;
      <a href="metric-affine.html">Metric-Affine</a> &middot;
      <a href="metric-affine-elastic.html"><strong>Metric-Affine Elastic</strong></a> &middot;
      <a href="exact.html">EXACT</a>
	    </small>
	    <small>Chunked bundling (bounded depth) + configurable geometry (D bytes)</small>
	  </div>
	
	  <div class="section-intro">
	    <p>Metric-Affine Elastic (EMA) extends Metric-Affine primarily with <strong>chunked bundling</strong> (bounded depth). The algebra stays the same (XOR bind and normalized L1 similarity), but capacity degrades more slowly under large superpositions because EMA avoids “bundle-of-bundles” gray drift.</p>
	    <p>In AGISystem2 terms, <strong>geometry = D</strong> (the number of byte channels per vector, i.e. `Uint8Array(D)`). EMA supports configurable `D` just like Metric-Affine; it does <strong>not</strong> auto-grow `D` during a session.</p>
	  </div>

  <h2>1. Why Elastic? The Gray-Convergence Problem</h2>

  <div class="concept-box">
    <h4>Problem: Mean Bundling Drifts Toward Gray</h4>
    <p>Metric-Affine bundles by arithmetic mean. When many vectors are superposed, the mean drifts toward ~128 in each byte, reducing contrast against the random baseline. Deep incremental updates (bundle of bundles) accelerate this drift.</p>
  </div>

  <div class="intuition">
    <em>Intuition:</em> If you keep averaging colors, you eventually get a uniform gray. EMA keeps multiple means (chunks) instead of a single gray average.
  </div>

  <div class="diagram-container">
    <svg viewBox="0 0 820 190" xmlns="http://www.w3.org/2000/svg" style="width: 100%; max-width: 820px;">
      <text x="410" y="20" text-anchor="middle" font-weight="bold" font-size="13" fill="#00897b">Mean Bundling Drift vs. Chunked Bundling</text>

      <rect x="40" y="35" width="340" height="130" rx="8" fill="#fff3e0" stroke="#f57c00"/>
      <text x="210" y="55" text-anchor="middle" font-size="11" fill="#e65100">Classic Mean (single bundle)</text>

      <rect x="70" y="75" width="40" height="24" fill="#ff9800"/><rect x="115" y="75" width="40" height="24" fill="#ffb74d"/>
      <rect x="160" y="75" width="40" height="24" fill="#ffc107"/><rect x="205" y="75" width="40" height="24" fill="#ffcc80"/>
      <rect x="250" y="75" width="40" height="24" fill="#ffe0b2"/>
      <text x="210" y="118" text-anchor="middle" font-size="10" fill="#666">Many items &rarr; single average</text>
      <rect x="120" y="130" width="180" height="20" rx="4" fill="#cfd8dc" stroke="#90a4ae"/>
      <text x="210" y="145" text-anchor="middle" font-size="10" fill="#455a64">Gray drift (low contrast)</text>

      <rect x="440" y="35" width="340" height="130" rx="8" fill="#e0f2f1" stroke="#00897b"/>
      <text x="610" y="55" text-anchor="middle" font-size="11" fill="#00695c">EMA (chunked bundles)</text>

      <rect x="470" y="75" width="80" height="20" rx="3" fill="#26a69a"/><text x="510" y="89" text-anchor="middle" font-size="9" fill="white">chunk A</text>
      <rect x="560" y="75" width="80" height="20" rx="3" fill="#4db6ac"/><text x="600" y="89" text-anchor="middle" font-size="9" fill="white">chunk B</text>
      <rect x="650" y="75" width="80" height="20" rx="3" fill="#80cbc4"/><text x="690" y="89" text-anchor="middle" font-size="9" fill="#004d40">chunk C</text>
      <rect x="490" y="110" width="240" height="20" rx="4" fill="#b2dfdb" stroke="#4db6ac"/>
      <text x="610" y="124" text-anchor="middle" font-size="10" fill="#00695c">Max-similarity picks best chunk</text>
    </svg>
  </div>

	  <h2>2. Geometry: Byte Channels (D)</h2>

	  <div class="definition">
	    <strong>Definition: EMA Vector</strong>
	    <p>EMA uses a configurable number of byte channels D:</p>
	    <p style="text-align: center; font-family: monospace; font-size: 14px;">
	      V = [b0, b1, ..., b(D-1)] where bi in {0..255}
	    </p>
	    <p>Default D matches Metric-Affine (32 bytes). You can run with 8/16/32/64/128+ bytes depending on the speed/capacity trade-off you want.</p>
	  </div>

  <div class="diagram-container">
	    <svg viewBox="0 0 820 170" xmlns="http://www.w3.org/2000/svg" style="width: 100%; max-width: 820px;">
	      <text x="410" y="20" text-anchor="middle" font-weight="bold" font-size="13" fill="#00897b">Prefix Stability Across D (manual configuration)</text>

      <rect x="70" y="40" width="240" height="24" rx="4" fill="#26a69a"/>
	      <text x="190" y="56" text-anchor="middle" font-size="10" fill="white">D=32B example</text>

      <rect x="70" y="75" width="320" height="24" rx="4" fill="#4db6ac"/>
      <rect x="310" y="75" width="80" height="24" rx="4" fill="#b2dfdb"/>
	      <text x="230" y="91" text-anchor="middle" font-size="10" fill="white">D=64B example (prefix kept)</text>
      <text x="350" y="91" text-anchor="middle" font-size="9" fill="#00695c">new</text>

      <rect x="70" y="110" width="480" height="24" rx="4" fill="#80cbc4"/>
      <rect x="390" y="110" width="160" height="24" rx="4" fill="#c8e6c9"/>
	      <text x="310" y="126" text-anchor="middle" font-size="10" fill="#004d40">D=128B example (prefix stable)</text>
      <text x="470" y="126" text-anchor="middle" font-size="9" fill="#2e7d32">new</text>

	      <text x="410" y="150" text-anchor="middle" font-size="10" fill="#455a64">V(name, 32B) == first 32 bytes of V(name, 64B/128B)</text>
	    </svg>
	  </div>

  <h2>3. Operations (Same Algebra, Different Bundle)</h2>

  <div class="math-block">
// Bind (byte-wise XOR)
(A XOR B)[i] = A[i] XOR B[i]

// Similarity (normalized L1)
sim(A, B) = 1 - (sum(|Ai - Bi|) / (D * 255))

// Bundle (EMA)
Bundle = [mean(chunk1), mean(chunk2), ...]
sim(Bundle, X) = max_j sim(mean_j, X)
  </div>

  <div class="warning-box">
    <strong>Important:</strong> EMA never bundles a bundle into a single mean. It keeps chunks as first-class parts of the bundle and uses max similarity across chunks.
  </div>

  <h2>4. Chunked Bundling in Practice</h2>

  <div class="diagram-container">
    <svg viewBox="0 0 820 200" xmlns="http://www.w3.org/2000/svg" style="width: 100%; max-width: 820px;">
      <text x="410" y="20" text-anchor="middle" font-weight="bold" font-size="13" fill="#00897b">Chunked Bundle Layout</text>

      <rect x="50" y="40" width="720" height="110" rx="8" fill="#f1f8e9" stroke="#7cb342"/>
      <text x="100" y="65" font-size="10" fill="#558b2f">KB bundle</text>

      <rect x="90" y="80" width="180" height="28" rx="4" fill="#aed581"/>
      <text x="180" y="98" text-anchor="middle" font-size="9" fill="#33691e">chunk 1 (mean)</text>
      <rect x="300" y="80" width="180" height="28" rx="4" fill="#c5e1a5"/>
      <text x="390" y="98" text-anchor="middle" font-size="9" fill="#33691e">chunk 2 (mean)</text>
      <rect x="510" y="80" width="180" height="28" rx="4" fill="#dcedc8"/>
      <text x="600" y="98" text-anchor="middle" font-size="9" fill="#33691e">chunk 3 (mean)</text>

      <path d="M180 112 L180 135 L390 135 L390 112" stroke="#558b2f" fill="none"/>
      <path d="M390 112 L390 135 L600 135 L600 112" stroke="#558b2f" fill="none"/>
      <text x="390" y="155" text-anchor="middle" font-size="10" fill="#33691e">Similarity = max of chunk matches</text>
    </svg>
  </div>

  <h2>5. Strategy Comparison</h2>

  <table class="comparison-table">
    <tr>
      <th>Feature</th>
      <th>Metric-Affine</th>
      <th>Metric-Affine Elastic</th>
    </tr>
    <tr>
      <td>Bind</td>
      <td>XOR (byte-wise)</td>
      <td>XOR (byte-wise)</td>
    </tr>
    <tr>
      <td>Similarity</td>
      <td>Normalized L1</td>
      <td>Normalized L1 (max over chunks)</td>
    </tr>
    <tr>
      <td>Bundle</td>
      <td>Single mean</td>
      <td>Chunked mean (no bundle-of-bundles)</td>
    </tr>
	    <tr>
	      <td>Geometry (D bytes)</td>
	      <td>Configurable (default 32B)</td>
	      <td>Configurable (default 32B; no auto-growth)</td>
	    </tr>
    <tr>
      <td>Best Use</td>
      <td>Small to mid KBs</td>
      <td>Large KB superpositions</td>
    </tr>
  </table>

  <h2>6. Usage</h2>

  <div class="definition">
    <strong>Initialize EMA</strong>
    <pre style="margin: 10px 0;">
// Initialize metric-affine-elastic strategy
initHDC('metric-affine-elastic');</pre>

    <strong>Environment Variable</strong>
    <pre style="margin: 10px 0;">
export SYS2_HDC_STRATEGY=metric-affine-elastic
node your-script.js</pre>
  </div>

	  <div class="concept-box">
	    <h4>Key Properties of EMA</h4>
	    <ul>
	      <li><strong>Perfect Self-Inverse:</strong> (A XOR B) XOR B = A exactly</li>
	      <li><strong>Chunked Bundling:</strong> Reduced gray drift under superposition</li>
	      <li><strong>Geometry (D bytes):</strong> Configurable vector length (manual)</li>
	      <li><strong>Prefix Stability:</strong> V(name, 32B) is a prefix of V(name, 64B/128B)</li>
	      <li><strong>Similarity Baseline:</strong> Same shifted baseline as Metric-Affine</li>
	    </ul>
	  </div>

  <div class="footer-nav">
    <p>
      <a href="../index.html">&larr; Back to Theory</a> &middot;
      <a href="dense-binary.html">Dense-Binary Strategy</a> &middot;
      <a href="sparse-polynomial.html">SPHDC Strategy</a> &middot;
      <a href="metric-affine.html">Metric-Affine Strategy</a> &middot;
      <a href="../../specsLoader.html?spec=DS/DS23-Elastic-Metric-Affine-HDC.md">DS23 Specification &rarr;</a>
    </p>
  </div>
  </div>
</body>
</html>
