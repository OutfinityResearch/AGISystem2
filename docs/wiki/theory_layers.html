<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Theory Layers</title>
  <link rel="stylesheet" href="../reference/style.css">
</head>
<body>
  <div class="page">
  <div class="nav-header">
    <h1>AGISystem2 – Theory Layers</h1>
    <small>
      <a href="../index.html">Home</a> ·
      <a href="../guides/conceptual_spaces.html">Theory</a> ·
      <a href="../architecture/index.html">Architecture</a> ·
      <a href="../api/index.html">APIs</a> ·
      <a href="../syntax/index.html">Syntax</a> ·
      <a href="../usage-cli/index.html">CLI</a> ·
      <a href="index.html">Wiki</a> ·
      <a href="../specs/matrix.html">Specs</a>
    </small>
  </div>

  <p>Theory layers let AGISystem2 maintain multiple, potentially contradictory views of the world simultaneously. Each layer can override or extend the knowledge below it. This enables counterfactual reasoning, context switching, and safe experimentation without corrupting base knowledge.</p>

  <div class="diagram">
    <svg viewBox="0 0 560 320" role="img" aria-label="Theory stack structure">
      <defs>
        <marker id="arrow-tl" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 z" fill="#0f4c81" />
        </marker>
      </defs>

      <!-- Background -->
      <rect x="0" y="0" width="560" height="320" fill="#fafbfc"/>

      <!-- Stack visualization -->
      <rect x="20" y="20" width="250" height="280" rx="4" fill="#f5f7fb" stroke="#b0b6c4" stroke-width="1"/>
      <text x="145" y="40" font-size="11" font-weight="bold" fill="#4a5670" text-anchor="middle">Theory Stack</text>

      <!-- Layer 3 (top - hypothetical) -->
      <rect x="40" y="55" width="210" height="50" rx="4" fill="#fff3e0" stroke="#e65100" stroke-width="2"/>
      <text x="55" y="75" font-size="10" font-weight="bold" fill="#e65100">Layer 3: "what-if"</text>
      <text x="55" y="92" font-size="9" fill="#4a5670">Water IS_A Gas (temp=200)</text>

      <!-- Layer 2 -->
      <rect x="40" y="115" width="210" height="50" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
      <text x="55" y="135" font-size="10" font-weight="bold" fill="#1976d2">Layer 2: "medical"</text>
      <text x="55" y="152" font-size="9" fill="#4a5670">Aspirin TREATS Headache</text>

      <!-- Layer 1 -->
      <rect x="40" y="175" width="210" height="50" rx="4" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
      <text x="55" y="195" font-size="10" font-weight="bold" fill="#2e7d32">Layer 1: "user session"</text>
      <text x="55" y="212" font-size="9" fill="#4a5670">User preferences, context</text>

      <!-- Base layer -->
      <rect x="40" y="235" width="210" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="2"/>
      <text x="55" y="255" font-size="10" font-weight="bold" fill="#0f4c81">Layer 0: Base Knowledge</text>
      <text x="55" y="272" font-size="9" fill="#4a5670">Dog IS_A Animal, Water IS_A Liquid</text>

      <!-- Stack pointer -->
      <line x1="265" y1="80" x2="285" y2="80" stroke="#e65100" stroke-width="2" marker-end="url(#arrow-tl)"/>
      <text x="290" y="84" font-size="9" fill="#e65100">← top (active)</text>

      <!-- Operations panel -->
      <rect x="300" y="20" width="240" height="130" rx="4" fill="#f5f7fb" stroke="#b0b6c4" stroke-width="1"/>
      <text x="420" y="40" font-size="11" font-weight="bold" fill="#4a5670" text-anchor="middle">Stack Operations</text>

      <rect x="320" y="55" width="200" height="25" rx="4" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="330" y="72" font-size="9" fill="#2e7d32">experiment PUSH any</text>

      <rect x="320" y="85" width="200" height="25" rx="4" fill="#fff3e0" stroke="#e65100" stroke-width="1"/>
      <text x="330" y="102" font-size="9" fill="#e65100">any POP any (discard top)</text>

      <rect x="320" y="115" width="200" height="25" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1"/>
      <text x="330" y="132" font-size="9" fill="#1976d2">name SAVE any / name LOAD any</text>

      <!-- Query resolution -->
      <rect x="300" y="165" width="240" height="130" rx="4" fill="#f5f7fb" stroke="#b0b6c4" stroke-width="1"/>
      <text x="420" y="185" font-size="11" font-weight="bold" fill="#4a5670" text-anchor="middle">Query Resolution</text>

      <text x="320" y="205" font-size="9" fill="#4a5670">ASK "Water IS_A ?"</text>
      <text x="320" y="225" font-size="9" fill="#4a5670">1. Check Layer 3 → Water IS_A Gas ✓</text>
      <text x="320" y="245" font-size="9" fill="#b0b6c4">2. (skip lower layers)</text>
      <text x="320" y="265" font-size="9" fill="#2e7d32" font-weight="bold">Result: Gas (from "what-if" layer)</text>
      <text x="320" y="285" font-size="8" fill="#4a5670">Base says Liquid, but Layer 3 overrides</text>
    </svg>
    <p class="diagram-caption">Theory layers stack like transparent overlays. Queries search from top to bottom, returning the first match. Layer 3 overrides the base knowledge that "Water IS_A Liquid" with "Water IS_A Gas" for hypothetical reasoning. Popping Layer 3 restores the original view.</p>
  </div>

  <h2>How Layers Work</h2>

  <p>Each layer contains facts that can add to or override facts in lower layers. When the <a href="../architecture/reasoning.html">Reasoner</a> processes a query, it searches layers from top to bottom. The first matching fact wins. If no layer has a match, the query returns unknown.</p>

  <p>Layers support three types of changes:</p>
  <ul>
    <li><strong>Additions</strong> – New facts not present below (e.g., "Aspirin TREATS Headache")</li>
    <li><strong>Overrides</strong> – Different value for existing fact (e.g., "Water IS_A Gas")</li>
    <li><strong>Retractions</strong> – Explicit removal of a fact from view (marker that blocks lookup)</li>
  </ul>

  <h2>Use Cases</h2>

  <table class="table-concept-index">
    <thead>
      <tr><th>Use Case</th><th>How Layers Help</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Counterfactuals</td>
        <td>Push a layer, add hypothetical facts, reason, then pop to restore reality</td>
      </tr>
      <tr>
        <td>User sessions</td>
        <td>Each user gets a layer with their preferences and context</td>
      </tr>
      <tr>
        <td>Domain switching</td>
        <td>Load a "medical" or "legal" layer with domain-specific knowledge</td>
      </tr>
      <tr>
        <td>Safe experimentation</td>
        <td>Test changes in a layer before committing to base</td>
      </tr>
      <tr>
        <td>Versioning</td>
        <td>Save layers as snapshots, load to restore previous states</td>
      </tr>
    </tbody>
  </table>

  <h2>Implementation</h2>

  <p>The <a href="../architecture/knowledge.html#theory-stack">TheoryStack</a> and <a href="../architecture/knowledge.html#theory-layer">TheoryLayer</a> components in the Knowledge Layer manage this:</p>

  <table class="table-concept-index">
    <thead>
      <tr><th>Operation</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><code>push(name)</code></td>
        <td>Create new layer at top of stack</td>
      </tr>
      <tr>
        <td><code>pop()</code></td>
        <td>Remove and discard top layer</td>
      </tr>
      <tr>
        <td><code>peek()</code></td>
        <td>Get current top layer</td>
      </tr>
      <tr>
        <td><code>save(filename)</code></td>
        <td>Persist current stack to disk</td>
      </tr>
      <tr>
        <td><code>load(filename)</code></td>
        <td>Restore stack from disk</td>
      </tr>
      <tr>
        <td><code>merge()</code></td>
        <td>Flatten top layer into the one below</td>
      </tr>
    </tbody>
  </table>

  <h2>Sys2DSL Commands</h2>

  <pre>
# Push a new layer
experiment PUSH any

# Add facts to current layer
@_ Water IS_A Gas
@_ Water TEMPERATURE_AT Celsius200

# Query (will find Gas, not Liquid)
@result Water IS_A ?

# Pop to discard hypothetical
any POP any

# Now Water IS_A Liquid again</pre>

  <h2>Related Documentation</h2>

  <ul>
    <li><a href="../architecture/knowledge.html#theory-stack">TheoryStack Implementation</a> – Stack management</li>
    <li><a href="../architecture/knowledge.html#theory-layer">TheoryLayer</a> – Individual layer structure</li>
    <li><a href="counterfactual.html">Counterfactual Reasoning</a> – Using layers for "what-if"</li>
    <li><a href="non_monotonic_logic.html">Non-Monotonic Logic</a> – How layers enable belief revision</li>
    <li><a href="../syntax/index.html">Syntax Reference</a> – PUSH, POP commands</li>
  </ul>

  <div class="footer-nav">
    <a href="lsh.html">← LSH</a> ·
    <a href="counterfactual.html">Counterfactuals →</a>
  </div>
  </div>
  <script src="../reference/nav2.js"></script>
</body>
</html>
