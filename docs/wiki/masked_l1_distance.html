<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Masked L1 Distance</title>
  <link rel="stylesheet" href="../reference/style.css">
</head>
<body>
  <div class="page">
  <div class="nav-header">
    <h1>AGISystem2 – Masked L1 Distance</h1>
    <small>
      <a href="../index.html">Home</a> ·
      <a href="../guides/conceptual_spaces.html">Theory</a> ·
      <a href="../architecture/index.html">Architecture</a> ·
      <a href="../api/index.html">APIs</a> ·
      <a href="../syntax/index.html">Syntax</a> ·
      <a href="../usage-cli/index.html">CLI</a> ·
      <a href="index.html">Wiki</a> ·
      <a href="../specs/matrix.html">Specs</a>
    </small>
  </div>

  <p>Masked L1 distance is the primary similarity metric in AGISystem2. It measures the Manhattan distance between two vectors, but only considers dimensions marked as relevant by a mask. This enables context-sensitive comparisons where different dimensions matter in different situations.</p>

  <div class="diagram">
    <svg viewBox="0 0 560 300" role="img" aria-label="Masked L1 distance computation">
      <defs>
        <marker id="arrow-ml1" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 z" fill="#0f4c81" />
        </marker>
      </defs>

      <!-- Background -->
      <rect x="0" y="0" width="560" height="300" fill="#fafbfc"/>

      <!-- Formula box -->
      <rect x="20" y="20" width="520" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="2"/>
      <text x="280" y="50" font-size="14" fill="#0f4c81" text-anchor="middle">d(a, b, mask) = Σ mask[i] × |a[i] - b[i]|</text>

      <!-- Vector A -->
      <text x="40" y="100" font-size="10" font-weight="bold" fill="#0f4c81">Vector A:</text>
      <rect x="100" y="85" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="115" y="102" font-size="10" fill="#0f4c81" text-anchor="middle">10</text>
      <rect x="130" y="85" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="145" y="102" font-size="10" fill="#0f4c81" text-anchor="middle">25</text>
      <rect x="160" y="85" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="175" y="102" font-size="10" fill="#0f4c81" text-anchor="middle">-5</text>
      <rect x="190" y="85" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="205" y="102" font-size="10" fill="#0f4c81" text-anchor="middle">40</text>
      <rect x="220" y="85" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="235" y="102" font-size="10" fill="#0f4c81" text-anchor="middle">15</text>
      <text x="260" y="102" font-size="10" fill="#4a5670">...</text>

      <!-- Vector B -->
      <text x="40" y="140" font-size="10" font-weight="bold" fill="#2e7d32">Vector B:</text>
      <rect x="100" y="125" width="30" height="25" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="115" y="142" font-size="10" fill="#2e7d32" text-anchor="middle">12</text>
      <rect x="130" y="125" width="30" height="25" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="145" y="142" font-size="10" fill="#2e7d32" text-anchor="middle">20</text>
      <rect x="160" y="125" width="30" height="25" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="175" y="142" font-size="10" fill="#2e7d32" text-anchor="middle">0</text>
      <rect x="190" y="125" width="30" height="25" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="205" y="142" font-size="10" fill="#2e7d32" text-anchor="middle">38</text>
      <rect x="220" y="125" width="30" height="25" fill="#e8f5e9" stroke="#2e7d32" stroke-width="1"/>
      <text x="235" y="142" font-size="10" fill="#2e7d32" text-anchor="middle">10</text>
      <text x="260" y="142" font-size="10" fill="#4a5670">...</text>

      <!-- Mask -->
      <text x="40" y="180" font-size="10" font-weight="bold" fill="#e65100">Mask:</text>
      <rect x="100" y="165" width="30" height="25" fill="#fff3e0" stroke="#e65100" stroke-width="1"/>
      <text x="115" y="182" font-size="10" fill="#e65100" text-anchor="middle">1</text>
      <rect x="130" y="165" width="30" height="25" fill="#fff3e0" stroke="#e65100" stroke-width="1"/>
      <text x="145" y="182" font-size="10" fill="#e65100" text-anchor="middle">1</text>
      <rect x="160" y="165" width="30" height="25" fill="#f5f5f5" stroke="#b0b6c4" stroke-width="1"/>
      <text x="175" y="182" font-size="10" fill="#b0b6c4" text-anchor="middle">0</text>
      <rect x="190" y="165" width="30" height="25" fill="#fff3e0" stroke="#e65100" stroke-width="1"/>
      <text x="205" y="182" font-size="10" fill="#e65100" text-anchor="middle">1</text>
      <rect x="220" y="165" width="30" height="25" fill="#f5f5f5" stroke="#b0b6c4" stroke-width="1"/>
      <text x="235" y="182" font-size="10" fill="#b0b6c4" text-anchor="middle">0</text>
      <text x="260" y="182" font-size="10" fill="#4a5670">...</text>

      <!-- Differences -->
      <text x="40" y="220" font-size="10" font-weight="bold" fill="#4a5670">|Diff|:</text>
      <rect x="100" y="205" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="115" y="222" font-size="10" fill="#0f4c81" text-anchor="middle">2</text>
      <rect x="130" y="205" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="145" y="222" font-size="10" fill="#0f4c81" text-anchor="middle">5</text>
      <rect x="160" y="205" width="30" height="25" fill="#f5f5f5" stroke="#b0b6c4" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="175" y="222" font-size="10" fill="#b0b6c4" text-anchor="middle">5</text>
      <rect x="190" y="205" width="30" height="25" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="205" y="222" font-size="10" fill="#0f4c81" text-anchor="middle">2</text>
      <rect x="220" y="205" width="30" height="25" fill="#f5f5f5" stroke="#b0b6c4" stroke-width="1" stroke-dasharray="3,2"/>
      <text x="235" y="222" font-size="10" fill="#b0b6c4" text-anchor="middle">5</text>

      <!-- Result -->
      <rect x="320" y="165" width="220" height="65" rx="4" fill="#f5f7fb" stroke="#0f4c81" stroke-width="2"/>
      <text x="330" y="185" font-size="10" fill="#4a5670">Masked sum: 2 + 5 + 0 + 2 + 0 = </text>
      <text x="470" y="185" font-size="12" font-weight="bold" fill="#0f4c81">9</text>
      <text x="330" y="205" font-size="9" fill="#4a5670">Unmasked would be: 2 + 5 + 5 + 2 + 5 = 19</text>
      <text x="330" y="220" font-size="9" fill="#4a5670">Masked dims (gray) are ignored</text>

      <!-- Labels -->
      <text x="100" y="250" font-size="9" fill="#4a5670">dim 0</text>
      <text x="130" y="250" font-size="9" fill="#4a5670">dim 1</text>
      <text x="160" y="250" font-size="9" fill="#b0b6c4">dim 2</text>
      <text x="190" y="250" font-size="9" fill="#4a5670">dim 3</text>
      <text x="220" y="250" font-size="9" fill="#b0b6c4">dim 4</text>

      <!-- Explanation -->
      <text x="20" y="285" font-size="9" fill="#4a5670">Grayed dimensions (mask=0) don't contribute to the distance. This focuses comparison on relevant features.</text>
    </svg>
    <p class="diagram-caption">The mask determines which dimensions count. Dimensions with mask=1 contribute their absolute difference to the total. Dimensions with mask=0 are ignored. This allows context-sensitive similarity comparisons.</p>
  </div>

  <h2>Why Masking?</h2>

  <p>Not all dimensions are relevant in every context. When comparing animals by behavior, physical appearance dimensions might be irrelevant. When comparing products by price, brand dimensions might not matter. The mask provides this flexibility without requiring different vector representations for different contexts.</p>

  <p>AGISystem2 uses separate dimension ranges for ontological (factual) and axiological (value) information. The <a href="../architecture/reasoning.html#bias-controller">BiasController</a> can automatically mask value dimensions when pure factual comparisons are needed, enabling the "veil of ignorance" mode for fair reasoning.</p>

  <h2>Implementation</h2>

  <p>The <a href="../architecture/geometry.html#math-engine">MathEngine</a> provides optimized distance computation:</p>

  <pre>
// Basic masked L1 distance
const dist = mathEngine.maskedL1(vectorA, vectorB, mask);

// With ontology-only mask (dims 0-255)
const ontoDist = mathEngine.maskedL1(vectorA, vectorB, ontologyMask);

// With full mask (all 384 dims)
const fullDist = mathEngine.maskedL1(vectorA, vectorB, fullMask);</pre>

  <h2>Mask Types</h2>

  <table class="table-concept-index">
    <thead>
      <tr><th>Mask Type</th><th>Dimensions</th><th>Use Case</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Full mask</td>
        <td>All 384</td>
        <td>Complete similarity including values</td>
      </tr>
      <tr>
        <td>Ontology mask</td>
        <td>0-255</td>
        <td>Factual similarity only (veil of ignorance)</td>
      </tr>
      <tr>
        <td>Axiology mask</td>
        <td>256-383</td>
        <td>Value similarity only</td>
      </tr>
      <tr>
        <td>Custom mask</td>
        <td>User-defined</td>
        <td>Domain-specific comparisons</td>
      </tr>
    </tbody>
  </table>

  <h2>Why L1 (Manhattan)?</h2>

  <p>L1 distance sums absolute differences rather than squared differences (L2/Euclidean). This has practical advantages:</p>
  <ul>
    <li><strong>Int8 friendly</strong> – No multiplication needed, avoiding overflow with saturating addition</li>
    <li><strong>Sparse-aware</strong> – A single large difference dominates, matching intuition about key features</li>
    <li><strong>Closed under diamonds</strong> – L1 balls (diamonds) have clean geometric properties</li>
  </ul>

  <h2>Related Documentation</h2>

  <ul>
    <li><a href="../architecture/geometry.html#math-engine">MathEngine</a> – Implementation details</li>
    <li><a href="bounded_diamonds.html">Bounded Diamonds</a> – How masks integrate with concept shapes</li>
    <li><a href="../architecture/reasoning.html#bias-controller">BiasController</a> – Automatic masking for fair reasoning</li>
    <li><a href="ontology.html">Ontology</a> – Factual dimension space</li>
    <li><a href="axiology.html">Axiology</a> – Value dimension space</li>
  </ul>

  <div class="footer-nav">
    <a href="bounded_diamonds.html">← Bounded Diamonds</a> ·
    <a href="lsh.html">LSH →</a>
  </div>
  </div>
  <script src="../reference/nav2.js"></script>
</body>
</html>
