<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Language Layer</title>
  <link rel="stylesheet" href="../reference/style.css">
</head>
<body>
  <div class="page">
  <div class="nav-header">
    <h1>AGISystem2 – Language Layer</h1>
    <small>
      <a href="../index.html">Home</a> ·
      <a href="../guides/conceptual_spaces.html">Theory</a> ·
      <a href="index.html">Architecture</a> ·
      <a href="../api/index.html">APIs</a> ·
      <a href="../syntax/index.html">Syntax</a> ·
      <a href="../usage-cli/index.html">CLI</a> ·
      <a href="../wiki/index.html">Wiki</a> ·
      <a href="../specs/matrix.html">Specs</a>
    </small>
    <div class="sub-nav">
      <strong>Architecture:</strong>
      <a href="index.html">Overview</a> ·
      <a href="geometry.html">Geometry</a> ·
      <a href="knowledge.html">Knowledge</a> ·
      <a href="learning.html">Learning</a> ·
      <a href="reasoning.html">Reasoning</a> ·
      <a href="inference.html">Inference</a> ·
      <a href="language.html">Language</a> ·
      <a href="storage.html">Storage</a> ·
      <a href="configuration.html">Configuration</a> ·
      <a href="evalsuite.html">Eval Suite</a>
    </div>
  </div>

  <p>The Language Layer transforms structured Sys2DSL commands into operations on the <a href="knowledge.html">Knowledge Layer</a>. It validates syntax, builds abstract representations, and encodes parsed structures into geometric points. This layer is the bridge between human-readable commands and the mathematical operations that implement reasoning.</p>

  <div class="section-intro">
    <p><strong>Specification:</strong> DS(/theory/dsl_engine) · DS(/theory/grammar) · DS(/theory/encoder)</p>
  </div>

  <h2>Sys2DSL Overview</h2>

  <p>Sys2DSL (System 2 Domain-Specific Language) is a constrained language designed for knowledge representation and querying. Its key properties:</p>

  <ul>
    <li><strong>Deterministic parsing</strong> – Unambiguous grammar ensures identical interpretation across runs</li>
    <li><strong>Structured format</strong> – Subject-Relation-Object triples map directly to geometric encoding</li>
    <li><strong>Testable</strong> – Commands can be scripted, versioned, and automated</li>
    <li><strong>Auditable</strong> – Every operation has a clear, logged representation</li>
  </ul>

  <div class="diagram">
    <svg viewBox="0 0 560 180" role="img" aria-label="Natural language to Sys2DSL translation">
      <defs>
        <marker id="arrow-lang" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 z" fill="#0f4c81" />
        </marker>
      </defs>

      <!-- Natural language -->
      <rect x="20" y="50" width="140" height="80" rx="6" fill="#f5f7fb" stroke="#2e7d32" stroke-width="2"/>
      <text x="90" y="70" font-size="9" font-weight="bold" fill="#2e7d32" text-anchor="middle">Natural Language</text>
      <text x="90" y="90" font-size="8" fill="#4a5670" text-anchor="middle">"Dogs are mammals"</text>
      <text x="90" y="105" font-size="8" fill="#4a5670" text-anchor="middle">"Fire causes smoke"</text>
      <text x="90" y="120" font-size="8" fill="#4a5670" text-anchor="middle">"Is a cat an animal?"</text>

      <!-- LLM/Translator (optional) -->
      <rect x="180" y="60" width="90" height="60" rx="6" fill="#fff3e0" stroke="#e65100" stroke-width="2" stroke-dasharray="4,2"/>
      <text x="225" y="80" font-size="8" font-weight="bold" fill="#e65100" text-anchor="middle">LLM Translation</text>
      <text x="225" y="95" font-size="7" fill="#4a5670" text-anchor="middle">(Chat mode)</text>
      <text x="225" y="108" font-size="7" fill="#4a5670" text-anchor="middle">Optional</text>

      <!-- Sys2DSL -->
      <rect x="290" y="50" width="140" height="80" rx="6" fill="#e1ecf7" stroke="#0f4c81" stroke-width="2"/>
      <text x="360" y="70" font-size="9" font-weight="bold" fill="#0f4c81" text-anchor="middle">Sys2DSL</text>
      <text x="360" y="90" font-size="8" fill="#4a5670" text-anchor="middle">@_ Dog IS_A Mammal</text>
      <text x="360" y="105" font-size="8" fill="#4a5670" text-anchor="middle">@_ Fire CAUSES Smoke</text>
      <text x="360" y="120" font-size="8" fill="#4a5670" text-anchor="middle">@q Cat IS_A Animal</text>

      <!-- Engine -->
      <rect x="450" y="60" width="90" height="60" rx="6" fill="#e1ecf7" stroke="#0f4c81" stroke-width="2"/>
      <text x="495" y="85" font-size="9" font-weight="bold" fill="#0f4c81" text-anchor="middle">Engine</text>
      <text x="495" y="100" font-size="7" fill="#4a5670" text-anchor="middle">Geometry ops</text>

      <!-- Arrows -->
      <line x1="160" y1="90" x2="178" y2="90" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrow-lang)"/>
      <line x1="270" y1="90" x2="288" y2="90" stroke="#e65100" stroke-width="1.5" marker-end="url(#arrow-lang)"/>
      <line x1="430" y1="90" x2="448" y2="90" stroke="#0f4c81" stroke-width="1.5" marker-end="url(#arrow-lang)"/>

      <!-- Direct path -->
      <path d="M 160 90 Q 180 140 288 90" fill="none" stroke="#0f4c81" stroke-width="1" stroke-dasharray="4,2"/>
      <text x="225" y="150" font-size="7" fill="#0f4c81" text-anchor="middle">Direct (Raw CLI)</text>
    </svg>
    <p class="diagram-caption">Translation paths to Sys2DSL. The Chat Interface uses an LLM to translate natural language. The Raw CLI accepts Sys2DSL directly. Both paths produce the same structured commands that the engine executes.</p>
  </div>

  <h2 id="grammar">Grammar Structure</h2>

  <p>Sys2DSL commands follow a consistent grammar. The full syntax reference is in the <a href="../syntax/index.html">Syntax Guide</a>.</p>

  <h3>Command Types (v2 legacy view)</h3>

  <table class="table-concept-index">
    <thead>
      <tr><th>Command</th><th>Syntax</th><th>Purpose</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Triple fact</strong></td>
        <td><code>@_ Subject VERB Object</code></td>
        <td>Add or update a fact in the knowledge base using verbs like <code>IS_A</code>, <code>HAS</code>, <code>CAUSES</code></td>
      </tr>
      <tr>
        <td><strong>Triple query</strong></td>
        <td><code>@var Subject VERB Object</code></td>
        <td>Query for truth value or retrieve composite results (for example with <code>FACTS</code>, <code>INSTANCES</code>, <code>QUERY</code>)</td>
      </tr>
      <tr>
        <td><strong>RETRACT</strong></td>
        <td><code>@_ Subject RELATION_NOT Object</code></td>
        <td>Remove a fact</td>
      </tr>
      <tr>
        <td><strong>PUSH</strong></td>
        <td><code>@_ name PUSH any</code></td>
        <td>Create new theory layer</td>
      </tr>
      <tr>
        <td><strong>POP</strong></td>
        <td><code>@_ any POP any</code></td>
        <td>Discard top theory layer</td>
      </tr>
      <tr>
        <td><strong>FACTS</strong></td>
        <td><code>@var Subject FACTS any</code></td>
        <td>Query for matching facts using the <code>FACTS</code> verb (replaces <code>FACTS_MATCHING</code>)</td>
      </tr>
    </tbody>
  </table>

  <h3>Relation Types</h3>

  <p>Relations are predefined keywords that specify the semantic relationship between subject and object:</p>

  <pre>
// Taxonomic relations
IS_A, HAS_INSTANCE, PART_OF, HAS_PART

// Causal relations
CAUSES, CAUSED_BY, ENABLES, PREVENTS

// Spatial relations
LOCATED_IN, CONTAINS, NEAR, FAR_FROM

// Temporal relations
BEFORE, AFTER, DURING, OVERLAPS

// Property relations
HAS_PROPERTY, HAS_VALUE, HAS_ATTRIBUTE

// Deontic relations
PERMITS, PROHIBITS, OBLIGATES, PERMITTED_BY, PROHIBITED_BY

// Similarity
SIMILAR_TO, DIFFERENT_FROM</pre>

  <p>See <a href="../syntax/relations.html">Relations Reference</a> for the complete list with semantics.</p>

  <h2>Parser</h2>

  <p>The DSL Parser validates syntax and produces an Abstract Syntax Tree (AST). The parser is deterministic and produces consistent output regardless of whitespace or formatting variations.</p>

  <h3>Parsing Stages</h3>

  <ol>
    <li><strong>Tokenization</strong> – Split input into tokens (keywords, identifiers, operators)</li>
    <li><strong>Syntax validation</strong> – Verify token sequence matches grammar rules</li>
    <li><strong>AST construction</strong> – Build tree representation of command</li>
    <li><strong>Semantic validation</strong> – Check relation compatibility, identifier validity</li>
  </ol>

  <pre>
// Input: "@_ Dog IS_A animal"
// Output (conceptual triple representation):
{
  subject: { type: "Identifier", value: "Dog" },
  verb:    { type: "Relation",  value: "IS_A" },
  object:  { type: "Identifier", value: "animal" }
}</pre>

  <h3>Error Handling</h3>

  <p>Parse errors include line number, column, and expected vs. actual tokens:</p>

  <pre>
ParseError at line 3, column 15:
  Expected: RELATION keyword (IS_A, CAUSES, PART_OF, ...)
  Found: "belongs_to"
  Context: "@_ Dog belongs_to Person"
                       ^^^^^^^^^</pre>

  <h2 id="encoder">Fact Encoder</h2>

  <p>The Fact Encoder transforms parsed AST nodes into geometric representations. It applies relation-specific permutations and combines vectors to create encodings suitable for storage and comparison.</p>

  <div class="diagram">
    <svg viewBox="0 0 520 200" role="img" aria-label="Fact encoding process">
      <defs>
        <marker id="arrow-enc" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 z" fill="#0f4c81" />
        </marker>
      </defs>

      <!-- AST input -->
      <rect x="20" y="60" width="100" height="80" rx="6" fill="#f5f7fb" stroke="#0f4c81" stroke-width="2"/>
      <text x="70" y="80" font-size="9" font-weight="bold" fill="#0f4c81" text-anchor="middle">AST Node</text>
      <text x="70" y="100" font-size="7" fill="#4a5670" text-anchor="middle">S: Dog</text>
      <text x="70" y="112" font-size="7" fill="#4a5670" text-anchor="middle">R: IS_A</text>
      <text x="70" y="124" font-size="7" fill="#4a5670" text-anchor="middle">O: Animal</text>

      <!-- Get vectors -->
      <rect x="140" y="40" width="100" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="190" y="60" font-size="8" font-weight="bold" fill="#0f4c81" text-anchor="middle">Get Vectors</text>
      <text x="190" y="75" font-size="7" fill="#4a5670" text-anchor="middle">v(Dog), v(Animal)</text>

      <!-- Get permutation -->
      <rect x="140" y="110" width="100" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="190" y="130" font-size="8" font-weight="bold" fill="#0f4c81" text-anchor="middle">Get Permutation</text>
      <text x="190" y="145" font-size="7" fill="#4a5670" text-anchor="middle">π(IS_A)</text>

      <!-- Apply permutation -->
      <rect x="260" y="75" width="100" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="310" y="95" font-size="8" font-weight="bold" fill="#0f4c81" text-anchor="middle">Permute Object</text>
      <text x="310" y="110" font-size="7" fill="#4a5670" text-anchor="middle">π(IS_A)(v(Animal))</text>

      <!-- Combine -->
      <rect x="380" y="75" width="100" height="50" rx="4" fill="#e1ecf7" stroke="#0f4c81" stroke-width="1"/>
      <text x="430" y="95" font-size="8" font-weight="bold" fill="#0f4c81" text-anchor="middle">Combine</text>
      <text x="430" y="110" font-size="7" fill="#4a5670" text-anchor="middle">v(Dog) + π(v(Animal))</text>

      <!-- Output -->
      <rect x="380" y="145" width="100" height="40" rx="6" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
      <text x="430" y="170" font-size="8" font-weight="bold" fill="#2e7d32" text-anchor="middle">Encoded Fact</text>

      <!-- Arrows -->
      <line x1="120" y1="90" x2="138" y2="70" stroke="#0f4c81" stroke-width="1" marker-end="url(#arrow-enc)"/>
      <line x1="120" y1="110" x2="138" y2="130" stroke="#0f4c81" stroke-width="1" marker-end="url(#arrow-enc)"/>
      <line x1="240" y1="65" x2="258" y2="90" stroke="#0f4c81" stroke-width="1" marker-end="url(#arrow-enc)"/>
      <line x1="240" y1="135" x2="258" y2="110" stroke="#0f4c81" stroke-width="1" marker-end="url(#arrow-enc)"/>
      <line x1="360" y1="100" x2="378" y2="100" stroke="#0f4c81" stroke-width="1" marker-end="url(#arrow-enc)"/>
      <line x1="430" y1="125" x2="430" y2="143" stroke="#2e7d32" stroke-width="1.5" marker-end="url(#arrow-enc)"/>
    </svg>
    <p class="diagram-caption">Fact encoding process. The encoder retrieves base vectors for subject and object, gets the relation-specific permutation, applies the permutation to the object vector, and combines with saturating addition to produce the encoded fact.</p>
  </div>

  <h3>Encoding Formula</h3>

  <pre>
encode(S, R, O) = v(S) + π_R(v(O))

where:
  v(X) = base vector for concept X
  π_R = permutation for relation R
  + = saturating addition (clamped to [-127, 127])</pre>

  <h2 id="query-compiler">Query Compiler</h2>

  <p>The Query Compiler transforms ASK commands into retrieval and reasoning operations. It determines the query type, identifies required concepts, and prepares the execution plan.</p>

  <h3>Query Types</h3>

  <table class="table-concept-index">
    <thead>
      <tr><th>Pattern</th><th>Type</th><th>Operation</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><code>@var S R O</code></td>
        <td>Yes/No</td>
        <td>Inclusion check of S in O via R</td>
      </tr>
      <tr>
        <td><code>@var S R ?</code></td>
        <td>What</td>
        <td>Find all O where S R O is true</td>
      </tr>
      <tr>
        <td><code>@var ? R O</code></td>
        <td>Who/What</td>
        <td>Find all S where S R O is true</td>
      </tr>
      <tr>
        <td><code>@var ? R ?</code></td>
        <td>List</td>
        <td>List all facts with relation R</td>
      </tr>
    </tbody>
  </table>

  <h2>Benefits of Sys2DSL</h2>

  <h3>Testability</h3>
  <p>Commands can be stored in files, versioned in git, and executed in CI pipelines:</p>

  <pre>
# test_taxonomy.sys2dsl
@_ Dog IS_A Mammal
@_ Mammal IS_A Animal
@result Dog IS_A Animal  # Expected: TRUE_CERTAIN</pre>

  <h3>Auditability</h3>
  <p>Every operation is logged with its exact command, enabling complete audit trails:</p>

  <pre>
2024-01-15 10:23:45 [INFO] @_ Dog IS_A Animal → OK
2024-01-15 10:23:46 [INFO] @result Dog IS_A Animal → TRUE_CERTAIN (0.95)
2024-01-15 10:23:47 [INFO] @_ experiment_1 PUSH any → depth=1</pre>

  <h3>Reproducibility</h3>
  <p>The deterministic grammar ensures that replaying the same command sequence always produces identical results—essential for debugging and verification.</p>

  <h2>Related Documentation</h2>

  <ul>
    <li><a href="../syntax/index.html">Syntax Reference</a> – Complete grammar documentation</li>
    <li><a href="../syntax/relations.html">Relations Reference</a> – All relation types with semantics</li>
    <li><a href="../wiki/sys2dsl.html">Sys2DSL Wiki</a> – Background and design rationale</li>
    <li><a href="../usage-cli/raw-cli.html">Raw CLI</a> – Using Sys2DSL directly</li>
    <li><a href="../usage-cli/chat-cli.html">Chat Interface</a> – Natural language translation to Sys2DSL</li>
  </ul>

  <div class="footer-nav">
    <a href="reasoning.html">← Reasoning</a> ·
    <a href="storage.html">Storage →</a>
  </div>
  </div>
  <script src="../reference/nav2.js"></script>
</body>
</html>
